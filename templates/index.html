<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Money Dashboard API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .card { border: none; margin-bottom: 2rem; }
        .card-header { background-color: #1f1f1f; color: #0dcaf0; font-weight: bold; }
        .table-container { background-color: #ffffff; color: #212529; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üöÄ E-Money Tool <small class="text-muted fs-6">v1.0-tmp</small></h2>
        <div>
            <input type="file" id="fileInput" class="d-none" multiple>
            <button class="btn btn-outline-info me-2" onclick="$('#fileInput').click()">+ Upload File</button>
            <button id="btnClear" class="btn btn-outline-danger">üóëÔ∏è Clear All Data</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">1. All Transactions (Full Detail)</div>
        <div class="card-body table-container">
            <table id="tableAll" class="table table-striped table-bordered w-100">
                <thead>
                    <tr>
                        <th>Date Time</th>
                        <th>Bank</th>
                        <th>Card Number</th>
                        <th>Amount</th>
                        <th>File Source</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">2. Filename Overview</div>
        <div class="card-body table-container">
            <table id="tableOverview" class="table table-hover w-100">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Total Trx</th>
                        <th>Total Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="overviewBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card border border-info">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>3. Settlement Detail (Ready to Download)</span>
            <button id="btnDownload" class="btn btn-sm btn-success d-none">üì© Download .txt</button>
        </div>
        <div class="card-body table-container">
            <div id="noDataText" class="text-center py-4 text-muted">
                <i>Belum ada data settlement. Pilih file dari tabel Overview di atas.</i>
            </div>
            <table id="tableSettlement" class="table table-bordered w-100 d-none">
                <thead>
                    <tr>
                        <th>MID</th>
                        <th>TID</th>
                        <th>Wkt Setel</th>
                        <th>Trx Count</th>
                        <th>Trx Amount</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
    let activeFilename = "";

    $(document).ready(function() {
        const tableAll = $('#tableAll').DataTable({ pageLength: 5 });
        const tableSetel = $('#tableSettlement').DataTable({ paging: false, info: false, searching: false });

        // Load Data Awal
        loadMainData();

        // Handle Clear Data
        $('#btnClear').on('click', function() {
            if(confirm('Hapus semua file di folder /tmp?')) {
                $.post('/api/clear-data', function(res) {
                    alert(res.message);
                    location.reload();
                });
            }
        });

        // Handle Upload File
        $('#fileInput').on('change', function() {
            const files = this.files;
            for(let i=0; i<files.length; i++) {
                let formData = new FormData();
                formData.append('file', files[i]);
                $.ajax({
                    url: '/api/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function() { 
                        if(i === files.length - 1) loadMainData(); 
                    }
                });
            }
        });

        // Handle Download
        $('#btnDownload').on('click', function() {
            if(activeFilename) window.location.href = `/api/download/${activeFilename}`;
        });
    });

    function loadMainData() {
        $.get('/api/init', function(data) {
            // Update Table All
            const tAll = $('#tableAll').DataTable();
            tAll.clear().rows.add(data.all.map(t => [
                t.trx_date, t.kode_bank, t.no_kartu, `Rp ${t.tarif.toLocaleString()}`, t.filename
            ])).draw();

            // Update Overview Body
            $('#overviewBody').empty();
            data.overview.forEach(item => {
                $('#overviewBody').append(`
                    <tr>
                        <td>${item.filename}</td>
                        <td>${item.total_trx}</td>
                        <td>Rp ${item.total_amount.toLocaleString()}</td>
                        <td><button class="btn btn-sm btn-info" onclick="selectFile('${item.filename}')">Select</button></td>
                    </tr>
                `);
            });
        });
    }

    function selectFile(filename) {
        activeFilename = filename;
        $('#noDataText').addClass('d-none');
        $('#tableSettlement, #btnDownload').removeClass('d-none');

        $.get(`/api/settlement/${filename}`, function(res) {
            const table = $('#tableSettlement').DataTable();
            table.clear().rows.add(res.map(s => [
                s.mid, s.tid, s.wktsetel, s.trxcount, `Rp ${s.trxamount.toLocaleString()}`
            ])).draw();
            
            $('html, body').animate({ scrollTop: $("#tableSettlement").offset().top }, 500);
        });
    }
</script>

</body>
</html>